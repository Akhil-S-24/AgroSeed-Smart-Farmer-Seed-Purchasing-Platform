<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Company Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="{{ url_for('static', filename='farmer_seeds.png') }}" type="image/png">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        .section-card {
            @apply bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-xl transition-all duration-300;
        }

        .table-head {
            @apply bg-green-100 text-green-800;
        }

        .action-btn {
            @apply px-3 py-1 text-sm rounded font-semibold;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-green-700 text-white py-5 shadow">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold">üå± Company Dashboard</h1>
                <p class="text-sm">Monitor and manage seeds, vendors, and users.</p>
            </div>
            <form action="/logout" method="POST">
                <button class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded">Logout</button>
            </form>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-10 flex flex-col gap-8 flex-grow">

        <!-- Seeds Card -->
        <div onclick="toggleSection('seeds-table',this)" class="section-card">
            <h2 class="text-2xl font-semibold text-green-700 flex items-center justify-between">
                üåæ Seeds
                <span class="cursor-pointer text-sm text-gray-600 toggle-text">Click to expand</span>
            </h2>
        </div>
        <div id="seeds-table" class="hidden bg-white p-6 rounded shadow">
            <div class="flex justify-end mb-2">
            </div>
            <table class="table-auto w-full border">
                <thead class="table-head">
                    <tr>

                        <th class="px-4 py-2">Name</th>
                        <th class="px-4 py-2">Type</th>
                        <th class="px-4 py-2">Quantity</th>
                        <th class="px-4 py-2">Rating</th>
                        <th class="px-4 py-2">Price</th>
                        <th class="px-4 py-2">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for seed in seeds %}
                    <tr class="border-t">
                        <td class="px-4 py-2">{{ seed.name }}</td>
                        <td class="px-4 py-2">{{ seed.type }}</td>
                        <td class="px-4 py-2">{{ seed.quantity }}</td>
                        <td class="px-4 py-2">{{ seed.rating if seed.rating else 'No rating' }}</td>
                        <td class="px-4 py-2">‚Çπ{{ seed.price }}</td>
                        <td class="px-4 py-2 space-x-2">

                            <a class="delete-btn inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md shadow transition duration-200 ease-in-out text-sm font-medium cursor-pointer"
                                data-id="{{ seed._id }}" data-type="seed">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12" />
                                </svg>
                                Delete Seed
                            </a>

                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Vendors Card -->
        <div onclick="toggleSection('vendors-table',this)" class="section-card">
            <h2 class="text-2xl font-semibold text-green-700 flex items-center justify-between">
                üë®‚Äçüåæ Vendors
                <span class=" cursor-pointer  text-sm text-gray-600 toggle-text">Click to expand</span>
            </h2>
        </div>
        <div id="vendors-table" class="hidden bg-white p-6 rounded shadow">
            <div class="flex justify-end mb-2">
            </div>
            <table class="table-auto w-full border">
                <thead class="table-head">
                    <tr>
                        <th class="px-4 py-2">Name</th>
                        <th class="px-4 py-2">Mobile</th>
                        <th class="px-4 py-2">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vendor in vendors %}
                    <tr class="border-t">
                        <td class="px-4 py-2">{{ vendor.username }}</td>
                        <td class="px-4 py-2">{{ vendor.mobile if vendor.mobile else 'No Phone Number' }}</td>
                        <td class="px-4 py-2 space-x-2">
                            <a class="delete-btn inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md shadow transition duration-200 ease-in-out text-sm font-medium cursor-pointer"
                                data-id="{{ vendor._id }}" data-type="vendor">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12" />
                                </svg>
                                Delete
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Pending Vendors Card -->
        <div onclick="toggleSection('pending-vendors-table',this)" class="section-card">
            <h2 class="text-2xl font-semibold text-yellow-700 flex items-center justify-between">
                üïí Pending Vendors
                <span class="cursor-pointer text-sm text-gray-600 toggle-text">Click to expand</span>
            </h2>
        </div>
        <div id="pending-vendors-table" class="hidden bg-white p-6 rounded shadow">
            <table class="table-auto w-full border">
                <thead class="table-head">
                    <tr>
                        <th class="px-4 py-2">Name</th>
                        <th class="px-4 py-2">Mobile</th>
                        <th class="px-4 py-2">Change Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vendor in pending_vendors %}
                    <tr class="border-t">
                        <td class="px-4 py-2">{{ vendor.username }}</td>
                        <td class="px-4 py-2">{{ vendor.mobile if vendor.mobile else 'No Phone Number' }}</td>
                        <td class="px-4 py-2 space-x-2">
                            <select class="status-select border px-2 py-1 rounded" data-id="{{ vendor._id }}">
                                <option value="">Select Action</option>
                                <option value="approved">Approve</option>
                                <option value="rejected">Reject</option>
                            </select>
                            <button
                                class="update-status-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm"
                                data-id="{{ vendor._id }}">
                                Update
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Farmers/Buyers Card -->
        <div onclick="toggleSection('booking-table',this)" class="section-card">
            <h2 class="text-2xl font-semibold text-green-700 flex items-center justify-between">
                üßë‚Äçüåæ Bookings
                <span class="cursor-pointer  text-sm text-gray-600 toggle-text">Click to expand</span>
            </h2>
        </div>
        <div id="booking-table" class="hidden bg-white p-6 rounded shadow">
            <div class="flex justify-end mb-2">
            </div>
            <table class="table-auto w-full border">
                <thead class="table-head">
                    <tr>
                        <th class="px-4 py-2">Seed Name</th>
                        <th class="px-4 py-2">Quantity</th>
                        <th class="px-4 py-2">Total Price</th>
                        <th class="px-4 py-2"> Status</th>
                        <th class="px-4 py-2"> Booking Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in bookings %}
                    <tr class="border-t">
                        <td class="px-4 py-2">{{ booking.seed_name }}</td>
                        <td class="px-4 py-2">{{ booking.quantity }}</td>
                        <td class="px-4 py-2">{{ booking.price }}</td>
                        <td class="px-4 py-2">{{ booking.status }}</td>
                        <td class="px-4 py-2">{{ booking.timestamp.strftime('%d %b %Y, %I:%M %p') }}</td>


                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div onclick="toggleSection('farmers-table',this)" class="section-card">
            <h2 class="text-2xl font-semibold text-green-700 flex items-center justify-between">
                üßë‚Äçüåæ Farmers / Buyers
                <span class="cursor-pointer  text-sm text-gray-600 toggle-text">Click to expand</span>
            </h2>
        </div>
        <div id="farmers-table" class="hidden bg-white p-6 rounded shadow">
            <div class="flex justify-end mb-2">
            </div>
            <table class="table-auto w-full border">
                <thead class="table-head">
                    <tr>
                        <th class="px-4 py-2">Name</th>
                        <th class="px-4 py-2">Mobile</th>
                        <th class="px-4 py-2">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in farmers %}
                    <tr class="border-t">
                        <td class="px-4 py-2">{{ user.username }}</td>
                        <td class="px-4 py-2">{{ user.mobile }}</td>
                        <td class="px-4 py-2 space-x-2">
                            <a class="delete-btn inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md shadow transition duration-200 ease-in-out text-sm font-medium cursor-pointer"
                                data-id="{{ user._id }}" data-type="farmer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12" />
                                </svg>
                                Delete
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div onclick="toggleSection('users-table',this)" class="section-card">
            <h2 class="text-2xl font-semibold text-green-700 flex items-center justify-between">
                üë®‚Äçüåæ Users
                <span class=" cursor-pointer  text-sm text-gray-600 toggle-text">Click to expand</span>
            </h2>
        </div>
        <div id="users-table" class="hidden bg-white p-6 rounded shadow">
            <div class="flex justify-end mb-2">
                <a id="addUserBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add
                    User</a>
            </div>
            <table class="table-auto w-full border">
                <thead class="table-head">
                    <tr>
                        <th class="px-4 py-2">Name</th>
                        <th class="px-4 py-2">Mobile</th>
                        <th class="px-4 py-2">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vendor in company %}
                    <tr class="border-t">
                        <td class="px-4 py-2">{{ vendor.username }}</td>
                        <td class="px-4 py-2">{{ vendor.mobile }}</td>
                        <td class="px-4 py-2 space-x-2">
                            <a class="delete-btn inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md shadow transition duration-200 ease-in-out text-sm font-medium cursor-pointer"
                                data-id="{{ vendor._id }}" data-type="user">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12" />
                                </svg>
                                Delete
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Modal -->
        <div id="addUserModal" class="fixed inset-0 bg-gray-500 bg-opacity-50 flex justify-center items-center hidden">
            <div class="bg-white p-6 rounded shadow-lg w-96">
                <h2 class="text-xl font-semibold mb-4">Add New User</h2>
                <form id="addUserForm">
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="username" name="username"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            required>
                    </div>
                    <div class="mb-4">
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" name="password"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            required>
                    </div>
                    <div class="mb-4">
                        <label for="mobile" class="block text-sm font-medium text-gray-700">Mobile</label>
                        <input type="text" id="mobile" name="mobile"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            required>
                    </div>
                    <div class="mb-4">
                        <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                        <input type="text" id="address" name="address"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            required>
                    </div>
                    <div class="mb-4">
                        <label for="usertype" class="block text-sm font-medium text-gray-700">User Type</label>
                        <select id="usertype" name="usertype"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm ">
                            <option value="Company">Company</option>
                        </select>
                    </div>

                    <div class="flex justify-end space-x-2">
                        <button type="button" id="closeModalBtn"
                            class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add
                            User</button>
                    </div>
                </form>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-200 text-gray-600 text-center py-4 text-sm">
        &copy; 2025 Company Dashboard. All rights reserved.
    </footer>
    <script>
        function toggleSection(id, element) {
            const section = document.getElementById(id);
            const toggleText = element.querySelector(".toggle-text");

            const isHidden = section.classList.toggle("hidden");
            toggleText.textContent = isHidden ? "Click to expand" : "Click to collapse";
        }




        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const button = e.currentTarget;
                const id = button.dataset.id;
                const type = button.dataset.type;

                if (!id || !type) return;

                const confirmDelete = confirm(`Are you sure you want to delete this ${type}?`);
                if (!confirmDelete) return;

                // Determine the API endpoint
                let endpoint = '';
                switch (type) {
                    case 'seed':
                        endpoint = `/api/farmer/delete-seed/${id}`;
                        break;
                    case 'vendor':
                        endpoint = `/api/company/vendors/${id}`;
                        break;
                    case 'farmer':
                        endpoint = `/api/company/farmers/${id}`;
                        break;
                    case 'user':
                        endpoint = `/api/company/users/${id}`;
                        break;
                    default:
                        alert('Unknown delete type');
                        return;
                }

                try {
                    const response = await fetch(endpoint, {
                        method: 'DELETE'
                    });
                    const result = await response.json();

                    if (result.success) {
                        alert(`${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully.`);
                        const row = button.closest('tr');
                        if (row) row.remove();
                    } else {
                        alert(`Failed to delete ${type}`);
                    }
                } catch (error) {
                    console.error(`Error deleting ${type}:`, error);
                    alert('An error occurred while deleting.');
                }
            });
        });


        // Get modal elements
        const addUserBtn = document.getElementById('addUserBtn');
        const addUserModal = document.getElementById('addUserModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const addUserForm = document.getElementById('addUserForm');

        // Show modal
        addUserBtn.addEventListener('click', () => {
            addUserModal.classList.remove('hidden');
        });

        // Close modal
        closeModalBtn.addEventListener('click', () => {
            addUserModal.classList.add('hidden');
        });

        // Handle form submission
        addUserForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const formData = new FormData(addUserForm);
            const userData = {
                username: formData.get('username'),
                mobile: formData.get('mobile'),
                usertype: formData.get('usertype'),
                password: formData.get('password'),
                address: formData.get('address')
            };

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (data.success) {
                    alert('User added successfully');
                    addUserModal.classList.add('hidden');
                    addUserForm.reset();
                } else {
                    alert('Failed to add user');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while adding the user');
            }
        });

        document.querySelectorAll('.update-status-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const vendorId = button.dataset.id;
                const select = document.querySelector(`.status-select[data-id="${vendorId}"]`);
                const newStatus = select.value;

                if (!newStatus) {
                    alert('Please select approve or reject');
                    return;
                }

                try {
                    const response = await fetch(`/api/company/vendors/update-status/${vendorId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    const result = await response.json();
                    if (result.success) {
                        alert('Status updated successfully');
                        // Remove the row or reload page
                        select.closest('tr').remove();
                    } else {
                        alert('Failed to update status');
                    }
                } catch (error) {
                    console.error('Error updating status:', error);
                    alert('An error occurred while updating status');
                }
            });
        });


    </script>


</body>

</html>